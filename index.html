<script>
    // API KALIT VA PARAMETRLAR
    const API_KEY = "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";
    let limit = localStorage.getItem('ai_limit_v2') ? parseInt(localStorage.getItem('ai_limit_v2')) : 8;

    function updateLimitUI() {
        const badge = document.getElementById('limit-badge');
        badge.innerText = `${limit}/8 imkoniyat`;
        if (limit <= 0) {
            document.getElementById('input-area').classList.add('hidden');
            document.getElementById('premium-blocker').classList.remove('hidden');
            badge.className = "text-[10px] text-red-600 font-bold px-2 bg-red-50 rounded-full";
        }
    }
    updateLimitUI();

    async function callAI(msg) {
        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${API_KEY}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": "https://learneasy.uz", // SHU JOYI MUHIM!
                    "X-Title": "Learneasy Platform"        // SHU JOYI MUHIM!
                },
                body: JSON.stringify({
                    "model": "google/gemini-2.0-flash-exp:free",
                    "messages": [
                        {
                            "role": "system", 
                            "content": "Sen Learneasy.uz sayti uchun maxsus yaratilgan professional AI agentsan. Matematika, fizika, kimyo, biologiya va chet tillarini (IELTS, CEFR) mukammal bilasan. Mustafobek tomonidan ishlab chiqilgansan. Javoblaring aniq va aqlli bo'lsin. Faqat o'zbek tilida javob ber."
                        },
                        {"role": "user", "content": msg}
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Xatosi:", errorData);
                return "Xatolik: API limiti tugagan yoki kalit noto'g'ri. Iltimos, VPN tekshiring.";
            }

            const data = await response.json();
            
            if (data.choices && data.choices.length > 0) {
                return data.choices[0].message.content;
            } else {
                return "AI hozircha javob bera olmayapti. Keyinroq urinib ko'ring.";
            }

        } catch (error) {
            console.error("Fetch xatosi:", error);
            return "Server bilan aloqa uzildi. Internetni yoki VPN-ni tekshiring.";
        }
    }

    async function processChat() {
        const input = document.getElementById('user-input');
        const flow = document.getElementById('chat-flow');
        const val = input.value.trim();

        if(!val || limit <= 0) return;

        // User Message
        flow.innerHTML += `<div class="flex justify-end mb-4"><div class="user-msg p-4 text-sm max-w-[85%] shadow-sm">${val}</div></div>`;
        input.value = "";
        
        limit--;
        localStorage.setItem('ai_limit_v2', limit);
        updateLimitUI();

        // Loader
        const loaderId = "loader-" + Date.now();
        flow.innerHTML += `<div id="${loaderId}" class="text-[10px] font-bold text-blue-500 animate-pulse py-2 pl-2">Learneasy AI o'ylamoqda...</div>`;
        flow.scrollTop = flow.scrollHeight;

        const result = await callAI(val);
        
        // Loaderni o'chirish
        const loaderElement = document.getElementById(loaderId);
        if(loaderElement) loaderElement.remove();

        // AI Message
        flow.innerHTML += `<div class="flex justify-start mb-4"><div class="ai-msg p-4 text-sm leading-relaxed max-w-[90%] shadow-sm bg-gray-100 border border-gray-200"><b>Learneasy AI:</b><br>${result}</div></div>`;
        flow.scrollTop = flow.scrollHeight;
    }

    document.getElementById('send-btn').onclick = processChat;
    document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') processChat(); };
</script>
