import React, { useState, useEffect } from "react";

const OPENROUTER_API_KEY = "YOUR_OPENROUTER_KEY"; // backendga o‚Äòtkazish tavsiya qilinadi
const MODEL = "meta-llama/llama-3-8b-instruct";

export default function App() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const [questionsLeft, setQuestionsLeft] = useState(8);
  const [cooldown, setCooldown] = useState(false);
  const [cooldownTime, setCooldownTime] = useState(null);
  const [loading, setLoading] = useState(false);

  // Instagram gradient
  const gradient =
    "linear-gradient(45deg, #feda75, #fa7e1e, #d62976, #962fbf, #4f5bd5)";

  // Initial AI Introduction
  useEffect(() => {
    const storedTime = localStorage.getItem("cooldownTime");
    const storedQuestions = localStorage.getItem("questionsLeft");

    if (storedTime) {
      const now = Date.now();
      if (now < parseInt(storedTime)) {
        setCooldown(true);
        setCooldownTime(parseInt(storedTime));
      } else {
        localStorage.removeItem("cooldownTime");
        localStorage.setItem("questionsLeft", 8);
      }
    }

    if (storedQuestions) {
      setQuestionsLeft(parseInt(storedQuestions));
    }

    setMessages([
      {
        role: "assistant",
        content: `Assalomu alaykum üëã  

Men Learneasy.uz sayti tomonidan maxsus ishlab chiqilgan professional AI agentman.

üéì Men quyidagilarda yordam bera olaman:
- Matematika
- Fizika
- Kimyo
- Biologiya
- Chet tillari va sertifikatga tayyorgarlik
- Uyga vazifalar
- Murakkab mavzularni sodda tushuntirish

‚ö†Ô∏è Sizda faqat 8 ta savol berish imkoniyati mavjud.
Bilimlar olamiga to‚Äòliq sho‚Äòng‚Äòish uchun premium obuna ‚Äî oyiga 12 000 so‚Äòm.`,
      },
    ]);
  }, []);

  // Cooldown timer
  useEffect(() => {
    if (!cooldown) return;

    const interval = setInterval(() => {
      if (Date.now() > cooldownTime) {
        setCooldown(false);
        setQuestionsLeft(8);
        localStorage.setItem("questionsLeft", 8);
        localStorage.removeItem("cooldownTime");
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [cooldown, cooldownTime]);

  const sendMessage = async () => {
    if (!input.trim() || cooldown || loading) return;
    if (questionsLeft <= 0) return;

    const newMessages = [...messages, { role: "user", content: input }];
    setMessages(newMessages);
    setInput("");
    setLoading(true);

    const remaining = questionsLeft - 1;
    setQuestionsLeft(remaining);
    localStorage.setItem("questionsLeft", remaining);

    if (remaining === 0) {
      const nextTime = Date.now() + 8 * 60 * 60 * 1000;
      setCooldown(true);
      setCooldownTime(nextTime);
      localStorage.setItem("cooldownTime", nextTime);
    }

    try {
      const response = await fetch(
        "https://openrouter.ai/api/v1/chat/completions",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${OPENROUTER_API_KEY}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: MODEL,
            temperature: 0.3,
            messages: [
              {
                role: "system",
                content:
                  "You are a professional educational AI. Give clear, structured, and accurate explanations. Avoid unnecessary text. Be precise.",
              },
              ...newMessages,
            ],
          }),
        }
      );

      const data = await response.json();

      setMessages([
        ...newMessages,
        {
          role: "assistant",
          content: data.choices?.[0]?.message?.content || "Xatolik yuz berdi.",
        },
      ]);
    } catch {
      setMessages([
        ...newMessages,
        { role: "assistant", content: "Server bilan bog‚Äòlanishda xatolik." },
      ]);
    }

    setLoading(false);
  };

  return (
    <div style={{ fontFamily: "sans-serif", background: "#fafafa" }}>
      {/* HEADER */}
      <div
        style={{
          background: gradient,
          padding: "15px",
          color: "white",
          display: "flex",
          justifyContent: "space-between",
        }}
      >
        <h2>Learneasy.uz</h2>
        <button
          style={{
            background: "white",
            borderRadius: "20px",
            padding: "8px 15px",
            border: "none",
            cursor: "pointer",
          }}
          onClick={() =>
            document
              .getElementById("chat-panel")
              .scrollIntoView({ behavior: "smooth" })
          }
        >
          AI Chat
        </button>
      </div>

      <div style={{ display: "flex", padding: "20px", gap: "20px" }}>
        {/* HOME PANEL */}
        <div
          style={{
            flex: 2,
            background: "white",
            borderRadius: "10px",
            padding: "20px",
            boxShadow: "0 0 10px rgba(0,0,0,0.1)",
          }}
        >
          <h3>Home Panel (Post joyi)</h3>
          <div
            style={{
              height: "200px",
              background: "#eee",
              borderRadius: "10px",
              marginBottom: "10px",
            }}
          />
          <div style={{ display: "flex", gap: "15px" }}>
            <button>‚ù§Ô∏è Like</button>
            <button>üí¨ Comment</button>
          </div>
        </div>

        {/* CHAT PANEL */}
        <div
          id="chat-panel"
          style={{
            flex: 1,
            background: "white",
            borderRadius: "10px",
            padding: "20px",
            boxShadow: "0 0 10px rgba(0,0,0,0.1)",
            display: "flex",
            flexDirection: "column",
            height: "500px",
          }}
        >
          <h3>AI Chat ({questionsLeft}/8)</h3>

          <div
            style={{
              flex: 1,
              overflowY: "auto",
              marginBottom: "10px",
            }}
          >
            {messages.map((msg, i) => (
              <div
                key={i}
                style={{
                  marginBottom: "10px",
                  textAlign: msg.role === "user" ? "right" : "left",
                }}
              >
                <div
                  style={{
                    display: "inline-block",
                    padding: "8px 12px",
                    borderRadius: "15px",
                    background:
                      msg.role === "user" ? "#d62976" : "#f1f1f1",
                    color: msg.role === "user" ? "white" : "black",
                  }}
                >
                  {msg.content}
                </div>
              </div>
            ))}
          </div>

          {cooldown ? (
            <div style={{ color: "red" }}>
              Limit tugadi. 8 soatdan keyin qayta urinib ko‚Äòring.
              <br />
              Premium: 12 000 so‚Äòm / oy
            </div>
          ) : (
            <>
              <input
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder="Savolingizni yozing..."
                style={{
                  padding: "10px",
                  borderRadius: "20px",
                  border: "1px solid #ccc",
                  marginBottom: "10px",
                }}
              />
              <button
                onClick={sendMessage}
                style={{
                  background: gradient,
                  color: "white",
                  border: "none",
                  padding: "10px",
                  borderRadius: "20px",
                  cursor: "pointer",
                }}
              >
                {loading ? "Yuborilmoqda..." : "Yuborish"}
              </button>
            </>
          )}
        </div>
      </div>
    </div>
  );
}
