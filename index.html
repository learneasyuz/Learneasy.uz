<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learneasy - AI Focus</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 font-sans h-screen flex flex-col">

<header class="bg-white border-b p-4 flex justify-between items-center shadow-sm">
    <div class="flex items-center gap-3">
        <img src="logo.png" class="w-10 h-10 rounded-full border border-blue-600" onerror="this.src='https://ui-avatars.com/api/?name=LE&background=0066ff&color=fff'">
        <h1 class="font-bold text-blue-700 italic">LEARNEASY</h1>
    </div>
    <div class="flex items-center gap-4">
        <span id="user-email" class="text-xs text-gray-500 font-medium"></span>
        <button id="logout-btn" class="text-xs bg-gray-100 hover:bg-red-50 text-red-500 px-3 py-1.5 rounded-lg border border-red-200 font-bold transition-all">CHIQISH (LOGOUT)</button>
    </div>
</header>

<main class="flex-1 flex flex-col md:flex-row overflow-hidden">
    <section class="flex-1 flex flex-col bg-white">
        <div class="p-4 border-b flex justify-between items-center bg-blue-50/50">
            <div>
                <h2 class="font-bold text-gray-800">ðŸ¤– AI O'qituvchi (33-Maktab)</h2>
                <p class="text-[10px] text-green-600 font-bold">ONLINE | MATEMATIKA VA FIZIKA MUTAXASSISI</p>
            </div>
            <div id="ai-status" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-black uppercase">Tayyor</div>
        </div>

        <div id="chat-flow" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30">
            <div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[80%] text-sm">
                Assalomu alaykum! Men **33-maktab** uchun maxsus yaratilgan AI yordamchiman. Qanday savolingiz bor?
            </div>
        </div>

        <div class="p-4 border-t bg-white">
            <div class="flex gap-2 max-w-4xl mx-auto">
                <input id="ai-input" type="text" placeholder="Matematika yoki fizikadan savol yozing..." class="flex-1 border border-gray-200 bg-gray-50 rounded-xl px-4 py-3 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all">
                <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl font-bold shadow-lg active:scale-95 transition-all">YUBORISH</button>
            </div>
            <div class="flex justify-between items-center mt-2 px-2">
                <p id="limit-text" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Limit: 8/8</p>
                <button id="premium-link" class="text-[10px] text-blue-600 font-bold hover:underline">PREMIUMGA O'TISH ðŸ’Ž</button>
            </div>
        </div>
    </section>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWEmiUblBJSk4_oY4EkPDWh1wtMRXyfo4",
        authDomain: "learneasy-social.firebaseapp.com",
        projectId: "learneasy-social",
        storageBucket: "learneasy-social.firebasestorage.app",
        messagingSenderId: "409211768065",
        appId: "1:409211768065:web:6a35c2e9a5a8ded0e05f00"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const API_KEY = "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";
    
    let currentLimit = 8;
    let isPremium = false;

    // LOGIN HOLATINI TEKSHIRISH
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "auth/login.html";
        } else {
            document.getElementById('user-email').innerText = user.email;
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const data = userSnap.data();
                isPremium = data.isPremium || false;
                currentLimit = isPremium ? 999 : (data.limit !== undefined ? data.limit : 8);
            } else {
                await setDoc(userRef, { email: user.email, limit: 8, isPremium: false, role: 'user' });
            }
            updateUI();
        }
    });

    function updateUI() {
        document.getElementById('limit-text').innerText = isPremium ? "LIMIT: CHEKSIZ âˆž" : `LIMIT: ${currentLimit}/8`;
    }

    // LOGOUT FUNKSIYASI
    document.getElementById('logout-btn').onclick = () => {
        signOut(auth).then(() => window.location.href = "auth/login.html");
    };

    // AI AGENT BUYRUQLARI (SYSTEM PROMPT) - 10 MARTA TAKRORLASH O'RNIGA BIR MARTA JUDA KUCHLI QILIB YOZILDI
    const SYSTEM_PROMPT = "Sen Marg'ilon shahridagi 33-maktabning Learneasy loyihasi uchun yaratilgan rasmiy AI yordamchisisan. Sen matematika va fizika fanlari bo'yicha mutaxassis o'qituvchisan. O'quvchilarga doimo do'stona, o'zbek tilida va tushunarli javob ber. Agar foydalanuvchi limiti tugagan bo'lsa, uni premium olishga chorla.";

    async function sendMessage() {
        const input = document.getElementById('ai-input');
        const flow = document.getElementById('chat-flow');
        const status = document.getElementById('ai-status');
        const text = input.value.trim();

        if (!text || currentLimit <= 0) {
            if (currentLimit <= 0) alert("Limitingiz tugadi! Premium sotib oling.");
            return;
        }

        // Foydalanuvchi xabari
        flow.innerHTML += `<div class="flex justify-end mb-2"><div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none text-sm max-w-[85%] shadow-md">${text}</div></div>`;
        input.value = "";
        
        // Limitni kamaytirish
        if (!isPremium) {
            currentLimit--;
            const user = auth.currentUser;
            await updateDoc(doc(db, "users", user.uid), { limit: currentLimit });
        }
        updateUI();

        // Loader
        const loader = document.createElement('div');
        loader.className = "text-[11px] text-blue-500 font-bold animate-pulse p-2";
        loader.innerText = "AI 33-maktab bazasidan javob qidirmoqda...";
        flow.appendChild(loader);
        flow.scrollTop = flow.scrollHeight;
        status.innerText = "O'YLANMOQDA...";

        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { 
                    "Authorization": "Bearer " + API_KEY, 
                    "Content-Type": "application/json",
                    "HTTP-Referer": window.location.origin 
                },
                body: JSON.stringify({
                    model: "meta-llama/llama-3.2-3b-instruct:free",
                    messages: [
                        {role: "system", content: SYSTEM_PROMPT},
                        {role: "system", content: "BUYRUQ: Doim 33-maktab yordamchisi ekanligingni unutma."},
                        {role: "user", content: text}
                    ]
                })
            });
            const data = await response.json();
            loader.remove();
            status.innerText = "TAYYOR";
            const reply = data.choices[0].message.content;
            flow.innerHTML += `<div class="flex justify-start mb-2"><div class="bg-white border border-gray-200 p-3 rounded-2xl rounded-tl-none text-sm max-w-[85%] shadow-sm"><b>ðŸ¤– AI:</b><br>${reply}</div></div>`;
        } catch (e) {
            loader.innerText = "Tarmoq xatosi! Iltimos qayta urining.";
            status.innerText = "XATO";
        }
        flow.scrollTop = flow.scrollHeight;
    }

    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('ai-input').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>

</body>
</html>
