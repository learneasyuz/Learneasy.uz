// App.jsx
import { useState, useEffect, useRef } from 'react';

function App() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [questionCount, setQuestionCount] = useState(0);
  const [lastReset, setLastReset] = useState(null);
  const messagesEndRef = useRef(null);

  const MAX_QUESTIONS = 8;
  const RESET_HOURS = 8;

  // localStorage dan o'qish
  useEffect(() => {
    const savedCount = localStorage.getItem('questionCount');
    const savedTime = localStorage.getItem('lastReset');

    if (savedCount) {
      setQuestionCount(parseInt(savedCount, 10));
    }
    if (savedTime) {
      setLastReset(new Date(savedTime));
    }

    // Birinchi xabar - AI tanishtiruvi
    if (messages.length === 0) {
      const intro = `Salom! Men Learneasy.uz sayti tomonidan maxsus ishlab chiqilgan AI agentman.

Men quyidagi yo'nalishlarda yordam beraman:
‚Ä¢ Matematika, fizika, kimyo, biologiya fanlarini sodda va aniq tushuntirish
‚Ä¢ Chet tillari (ingliz, rus va boshqalar) bo'yicha sertifikatlarga tayyorlash
‚Ä¢ Uy vazifalari, testlar, masalalar yechishda yordam
‚Ä¢ Har qanday mavzuni professional va batafsil tahlil qilish

Eslatma: Bu yerda sizga **faqat 8 ta savol** berish imkoniyati mavjud (bepul versiya uchun). 
Savollar tugagach, imkoniyat 8 soatdan keyin yangilanadi yoki Premium obuna orqali cheksiz foydalanishingiz mumkin.

Premium (bir oy ‚Äì 12 000 so'm):
‚Ä¢ Cheksiz savol-javob
‚Ä¢ Tezroq va yanada chuqurroq javoblar

To'lov qilish uchun saytga o'ting: https://learneasy-uz.vercel.app (karta orqali to'lov bor)

Savolingizni yozing, men professional tarzda javob beraman! üöÄ`;

      setMessages([{ role: 'ai', content: intro }]);
    }
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const checkReset = () => {
    if (lastReset) {
      const now = new Date();
      const diffHours = (now - lastReset) / (1000 * 60 * 60);
      if (diffHours >= RESET_HOURS) {
        setQuestionCount(0);
        localStorage.setItem('questionCount', '0');
        localStorage.setItem('lastReset', now.toISOString());
        setLastReset(now);
        alert("8 soat o'tdi! Yangi 8 ta savol imkoniyati ochildi.");
      }
    }
  };

  const handleSend = () => {
    if (!input.trim()) return;

    checkReset();

    if (questionCount >= MAX_QUESTIONS) {
      setMessages(prev => [...prev, 
        { role: 'user', content: input },
        { role: 'ai', content: `Sizning bepul imkoniyatingiz (8 ta savol) tugadi. Yana 8 soat kuting yoki Premium obuna bo'ling!\n\nPremium: 12 000 so'm / oy ‚Äì cheksiz savol, tez javoblar.\nTo'lov ‚Üí https://learneasy-uz.vercel.app` }
      ]);
      setInput('');
      return;
    }

    const userMsg = { role: 'user', content: input };
    setMessages(prev => [...prev, userMsg]);

    // Bu yerda real AI (masalan Grok/OpenAI API) chaqiriladi
    // Hozircha oddiy echo qilib qo'yamiz, real loyihada API qo'ying
    setTimeout(() => {
      const aiReply = `Bu sizning ${questionCount + 1}-savolingizga javob (real AI integratsiyasi kerak).\nSiz yozgan: "${input}"\n\nJavob: Bu yerda LLM dan kelgan aniq, professional javob bo'lardi. Masalan, matematika masalasi bo'lsa ‚Äì bosqichma-bosqich yechim, formula LaTeX bilan va h.k.`;

      setMessages(prev => [...prev, { role: 'ai', content: aiReply }]);
    }, 800);

    // Limitni yangilash
    const newCount = questionCount + 1;
    setQuestionCount(newCount);
    localStorage.setItem('questionCount', newCount.toString());
    if (newCount === 1) {
      localStorage.setItem('lastReset', new Date().toISOString());
      setLastReset(new Date());
    }

    setInput('');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#feda75] via-[#fa7e1e] via-[#d62976] via-[#962fbf] to-[#4f5bd5] text-white">
      <div className="container mx-auto flex h-screen">
        
        {/* Chap panel - Home / Postlar */}
        <div className="w-1/2 bg-black/40 backdrop-blur-md border-r border-white/20 p-6 overflow-y-auto">
          <h1 className="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-[#feda75] to-[#d62976] bg-clip-text text-transparent">
            Learneasy Social
          </h1>
          
          <div className="space-y-6">
            {/* Placeholder post */}
            <div className="bg-white/10 rounded-xl p-4">
              <p className="text-lg mb-3">Hozircha postlar yo'q. Tez orada video, rasm, like va commentlar qo'shiladi!</p>
              <div className="flex gap-4 mt-4">
                <button className="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full hover:bg-white/30">
                  ‚ù§Ô∏è Like (0)
                </button>
                <button className="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full hover:bg-white/30">
                  üí¨ Comment
                </button>
              </div>
            </div>

            {/* Yangi post joyi */}
            <div className="bg-white/5 p-4 rounded-xl">
              <textarea 
                placeholder="Yangi post yozing (video/rasm hali qo'shilmagan)..."
                className="w-full bg-transparent border-b border-white/30 focus:outline-none text-white placeholder-white/60 resize-none h-24"
              />
              <button className="mt-3 bg-gradient-to-r from-[#833AB4] to-[#C13584] px-6 py-2 rounded-full font-semibold">
                Post joylash
              </button>
            </div>
          </div>
        </div>

        {/* O'ng panel - AI Chat */}
        <div className="w-1/2 flex flex-col bg-black/50 backdrop-blur-lg">
          <div className="p-4 border-b border-white/20 bg-gradient-to-r from-[#833AB4]/80 to-[#C13584]/80">
            <h2 className="text-xl font-bold">Learneasy AI yordamchi</h2>
            <p className="text-sm opacity-80">Qolgan savollar: {MAX_QUESTIONS - questionCount}</p>
          </div>

          <div className="flex-1 p-6 overflow-y-auto space-y-4">
            {messages.map((msg, i) => (
              <div 
                key={i} 
                className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div 
                  className={`max-w-[80%] p-4 rounded-2xl ${
                    msg.role === 'user' 
                      ? 'bg-gradient-to-r from-[#4f5bd5] to-[#833AB4] text-white' 
                      : 'bg-white/15 text-white'
                  }`}
                >
                  {msg.content}
                </div>
              </div>
            ))}
            <div ref={messagesEndRef} />
          </div>

          <div className="p-4 border-t border-white/20 flex gap-3 bg-black/40">
            <input
              type="text"
              value={input}
              onChange={e => setInput(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handleSend()}
              placeholder="Savolingizni yozing..."
              disabled={questionCount >= MAX_QUESTIONS}
              className="flex-1 bg-white/10 border border-white/30 rounded-full px-6 py-3 focus:outline-none focus:border-[#d62976] text-white placeholder-white/60 disabled:opacity-50"
            />
            <button 
              onClick={handleSend}
              disabled={questionCount >= MAX_QUESTIONS || !input.trim()}
              className="bg-gradient-to-r from-[#d62976] to-[#962fbf] px-8 py-3 rounded-full font-bold hover:opacity-90 disabled:opacity-50"
            >
              Yuborish
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

export default App;
